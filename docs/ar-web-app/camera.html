<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="ARte web app">
        <meta name="keywords" content="">
        <meta name="author" content="ARte team">
        <title>ARte</title>

        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="./css/style.css">

        <!-- AR libs -->
        <script src="./js/aframe-master.min.js"></script>
        <script src="./js/aframe-ar-nft.js"></script>

        <!-- Utility -->
        <script src="./js/aws.js"></script>
        <script src="./js/pahoMQTTClient.js"></script>
        <script src="./js/utils.js"></script>

        <!-- External libs -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
        <script src="./js/jquery-3.5.1.min.js"></script>

        <!-- ARte js library -->
        <script src="./js/ARte.js"></script>
        <script src="./js/gesture-detector.js"></script>

        <!--<script>
          AFRAME.registerComponent('markerhandler', {
            init: function () {
              const marker = this.el;
              alert(marker);

        			marker.addEventListener("markerFound", ()=> {
        				var markerId = marker.id;
        				alert('Marker Found: ', markerId);
        			});

        			marker.addEventListener("markerLost",() =>{
        				var markerId = marker.id;
        				alert('Marker Lost: ', markerId);
        			});
            }
          });
      </script>-->
    </head>
    <body class="page-camera">
        <!-- Header -->
        <header>
            <a href="">
                <img src="./img/logo_white.png" alt="logo">
            </a>
        </header>

        <!-- Minimal loader shown until image descriptors are loaded -->
        <div class="arjs-loader">
            <div>Loading, please wait...</div>
        </div>

        <!-- Artwork description -->
        <div id="artwork" hidden>
            <div class="title"></div>
        </div>

        <!-- Info popup -->
        <div id="info" hidden>
            <p></p>
        </div>

        <!-- Features panel -->
        <div class="commands">
            <div class="button" id="color">
                <img src="./img/icons/palette.svg" alt="Color">
            </div>
            <div class="button" id="music">
                <img src="./img/icons/note.svg" alt="Music">
            </div>
        </div>


        <!-- Color animation box -->
        <div id="color-box"></div>
        <div id="color-box-2"></div>

        <!-- AR core -->
        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            gesture-detector
            embedded
            id="scene">

            <!-- url='https://arte-team.github.io/ARte/ar-web-app/img/markers/1' -->
            <a-nft type='nft'
                   url='ar-web-app/img/markers/Discobolus/Discobolus'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model"
                         light="intensity: 1;"
                         id="light">
                    <!--<a-entity id="directionaltarget" position="0 0 -1"></a-entity>-->
                </a-light>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model"
                         light="intensity: 0;"
                         id="light2">
                    <!--<a-entity id="directionaltarget" position="0 0 -1"></a-entity>-->
                </a-light>
                <a-entity
                    gltf-model='../Dashboard/files/assets/uploads/models/Discobolus/scene.gltf'
                    scale="0.15 0.15 0.15"
                    position="80 -20 -100"
                    rotation="-90 0 0"
                    gesture-handler="minScale: 0.25; maxScale: 10"
                    id="model">
                </a-entity>
            </a-nft>

            <!-- url='https://arte-team.github.io/ARte/ar-web-app/img/markers/1' -->
            <a-nft type='nft'
                   url='ar-web-app/img/markers/Nike of Samothrace/Nike of Samothrace'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model2"
                         light="intensity: 3;"
                         id="light2_1">
                    <!--<a-entity id="directionaltarget2_1" position="0 -30 -80"></a-entity>-->
                </a-light>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model2"
                         light="intensity: 0;"
                         id="light2_2">
                    <!--<a-entity id="directionaltarget2_2" position="0 -30 -80"></a-entity>-->
                </a-light>
                <!-- Different gltf model -->
                <!--<a-entity
                    gltf-model='../Dashboard/files/assets/uploads/models/Nike of Samothrace/scene.gltf'
                    scale="90 90 90"
                    position="120 -50 -100"
                    rotation="-90 0 0"
                    gesture-handler="minScale: 0.25; maxScale: 10"
                    id="model2">
                </a-entity>-->
                <a-entity
                    gltf-model='../Dashboard/files/assets/uploads/models/Nike of Samothrace/scene.gltf'
                    scale="5 5 5"
                    position="120 -30 -80"
                    rotation="-90 0 0"
                    gesture-handler="minScale: 0.25; maxScale: 10"
                    id="model2">
                </a-entity>
            </a-nft>

            <a-nft type='nft'
                   url='ar-web-app/img/markers/Artemision Bronze/Artemision Bronze'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model3"
                         light="intensity: 1;"
                         id="light3_1">
                    <!--<a-entity id="directionaltarget3_1" position="0 -50 -100"></a-entity>-->
                </a-light>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model3"
                         light="intensity: 0;"
                         id="light3_2">
                    <!--<a-entity id="directionaltarget3_2" position="0 -50 -100"></a-entity>-->
                </a-light>
                <a-entity
                    gltf-model='../Dashboard/files/assets/uploads/models/Artemision Bronze/scene.gltf'
                    scale="0.1 0.1 0.1"
                    position="110 -50 -100"
                    rotation="-90 0 0"
                    gesture-handler="minScale: 0.25; maxScale: 10"
                    id="model3">
                </a-entity>
            </a-nft>

            <a-nft type='nft'
                   url='ar-web-app/img/markers/Lion Gate of Mycenae/Lion Gate of Mycenae'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'>
                <a-light type="directional"
                         position="0 100 100"
                         rotation="0 0 0"
                         color="#FFFFFF"
                         target="#directionaltarget4_1"
                         light="intensity: 2;"
                         id="light4_1">
                    <a-entity id="directionaltarget4_1" position="0 -50 0"></a-entity>
                </a-light>
                <a-light type="directional"
                         position="0 100 100"
                         rotation="0 0 0"
                         color="#FFFFFF"
                         target="#directionaltarget4_1"
                         light="intensity: 0;"
                         id="light4_2">
                </a-light>
                <a-entity
                    gltf-model='../Dashboard/files/assets/uploads/models/Lion Gate of Mycenae/scene.gltf'
                    scale="30 30 30"
                    position="120 -50 -200"
                    rotation="-90 0 0"
                    gesture-handler="minScale: 0.25; maxScale: 10"
                    id="model4">
                </a-entity>
            </a-nft>

            <a-nft type='nft'
                   url='ar-web-app/img/markers/Athena of Velletri/Athena of Velletri'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model5"
                         light="intensity: 1;"
                         id="light5_1">
                    <!--<a-entity id="directionaltarget5_1" position="0 -50 0"></a-entity>-->
                </a-light>
                <a-light type="directional"
                         position="0 0 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#model5"
                         light="intensity: 0;"
                         id="light5_2">
                    <!--<a-entity id="directionaltarget5_2" position="0 0 0"></a-entity>-->
                </a-light>
                <a-entity
                    gltf-model='../Dashboard/files/assets/uploads/models/Athena of Velletri/scene.gltf'
                    scale="50 50 50"
                    position="120 -50 -100"
                    rotation="-90 0 0"
                    gesture-handler="minScale: 0.25; maxScale: 10"
                    id="model5">
                </a-entity>
            </a-nft>


            <!-- NON HO TROVATO UN MODELLO PER QUESTO -->
            <!--<a-nft type='nft'
                   url='ar-web-app/img/markers/Chariotter of Delphi/Chariotter of Delphi'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'>
                <a-light type="directional"
                         position="0 0 0"
                         rotation="-90 0 0"
                         color="#FFF"
                         target="#directionaltarget"
                         light="intensity: 1;"
                         id="light2_1">
                    <a-entity id="directionaltarget" position="0 0 -1"></a-entity>
                </a-light>
                <a-light type="directional"
                         position="0 0 0"
                         rotation="-90 0 0"
                         color="#FFF"
                         target="#directionaltarget"
                         light="intensity: 0;"
                         id="light2_2">
                    <a-entity id="directionaltarget" position="0 0 -1"></a-entity>
                </a-light>
                <a-entity
                    gltf-model='../Dashboard/files/assets/uploads/models/Chariotter of Delphi/scene.gltf'
                    scale="90 90 90"
                    position="120 -50 -100"
                    rotation="-90 0 0"
                    gesture-handler="minScale: 0.25; maxScale: 10"
                    id="model2">
                </a-entity>
            </a-nft>-->

            <a-entity camera></a-entity>
        </a-scene>

        <script>
            // Set unique deviceID for the user
            // Check if cookie is already present
            var uuid;

            if(accessCookie("deviceID") == '') {
                uuid = createUUID();
                createCookie("deviceID", uuid, 12);
            } else {
                uuid = accessCookie("deviceID");
            }

            var mqttClient = null;

            function onConnect() {}

            // Initialize Amazon Cognito credentials provider
            AWS.config.region      = 'us-east-1';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
              IdentityPoolId: 'us-east-1:73b2cfba-525a-4f90-ba69-2c4ca9de375a',
            });


            // Obtain credentials
            AWS.config.credentials.get(function(){
              // Credentials will be available when this function is called
              var host       = 'a38agfpa1egwwp-ats.iot.us-east-1.amazonaws.com';
              var requestUrl = SigV4Utils.getSignedUrl(host, AWS.config.region, AWS.config.credentials);
              mqttClient     = new PahoMQTTClient(requestUrl, uuid);
              mqttClient.conn(onConnect);
            });


            // Initialize ARte object for feature interaction
            var arte = new ARte(uuid);

            var message = '';


            // Send message to broker when browser is idle mode
            // Set visibilitychange event listener
            function sendMessageIdle() {
                if ( document.hidden ) {
                    message = arte.getMessage();
                    mqttClient.pub(message, 'daily');
                    arte.stopFeature();

                    $('.commands .button').removeClass('pressed');
                } else  {
                    //startFeature();
                }
            }

            document.addEventListener( 'visibilitychange', sendMessageIdle, false );

            var el = document.getElementById( "model" );
            var initialScale = el.object3D.scale.clone();
            var scaleFactor = 1;
            var rotationFactor = 2;


            // Scale model when double finger gesture is detected
            function handleScale( event ) {
                scaleFactor *= 1 + event.detail.spreadChange / event.detail.startSpread;
                scaleFactor = Math.min( Math.max( scaleFactor, 0.25 ), 10 );

                el.object3D.scale.x = scaleFactor * initialScale.x;
                el.object3D.scale.y = scaleFactor * initialScale.y;
                el.object3D.scale.z = scaleFactor * initialScale.z;
            }


            // Rotate model when one finger gesture is detected
            function handleRotation( event ) {
                sceneEl.camera.rotation.y += event.detail.positionChange.x;// * rotationFactor;
                sceneEl.camera.rotation.x += event.detail.positionChange.y;// * rotationFactor;
            }

            var sceneEl = document.getElementById( "scene" );
            sceneEl.addEventListener( 'onefingermove', handleRotation );
            sceneEl.addEventListener( 'twofingermove', handleScale );


            // Background gradient simulation
            var rooms = [10, 4, 2, 5, 15, 3, 2, 10, 5, 6, 8, 8, 20, 1, 0, 13, 7, 9, 10];
            var colors = [];
            var lights = [];

            var mult = Math.floor( rooms.length / 6 );      // Multiplicator for background colors value calculation
            var time = 0;                                   // Clock for background gradient
            var dir = 1;                                    // Light gradient direction

            var color_event;
            var light_event;

            for( i = 0; i < 6; i++ ) {
                colors[i] = 0;
                for( j = 0; j < Math.floor( rooms.length / 6 ); j++ ) {
                    colors[i] += rooms[i+(j*6)];
                }
            }

            for(i = 0; i < colors.length; i++) {
                colors[i] = Math.max( Math.min( ( colors[i] * 255 / ( 30*mult ) ) + ( 20*i ), 255 ), 0 );
            }

            for(i = 0; i < 3; i++) {
                lights[i] = Math.max( Math.min( parseInt( ( ( colors[i] /* + colors[i+3] */ ) ) - 20 ), 255 ), 0 );
            }

            var deg = ( rooms.reduce( function( a, b ) { return a + b; }, 0 ) % ( 30*rooms.length ) ) * 360 / ( 30*rooms.length );


            $( document ).ready(function() {

                $( '#color-box' ).css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );


                // Color manager
                $('#color').click(function() {
                    var status = arte.featureAttributes.status;

                    if( status == 0 ) {
                        $( '#color-box' ).css( 'opacity', '1');
                        $( '#color-box-2' ).css( 'opacity', '1');
                        $( '#light2' ).attr( 'color', 'rgb(' + lights[0] + ',' + lights[1] + ',' + lights[2] + ')' );
                        color_event = setInterval( color_func, 1500 );
                        light_event = setInterval( light_func, 10 );
                        arte.featureAttributes.status = 1;
                    } else if( status == 1 ) {
                        $( '#color-box' ).css( 'opacity', '0');
                        $( '#color-box-2' ).css( 'opacity', '0');
                        $( '#light' ).attr( 'color', '#FFF' );
                        $( '#light2' ).attr( 'color', '#FFF' );
                        clearInterval( color_event );
                        clearInterval( light_event );
                        arte.featureAttributes.status = 0;
                    }
                });


                // Music manager
                $('#music').click(function() {
                    var status = arte.featureAttributes.status;

                    if( status == 0 ) {

                        arte.featureAttributes.status = 1;
                    } else if( status == 1 ) {

                        arte.featureAttributes.status = 0;
                    }
                });


                // Changing style to buttons when pressed
                // Start and stop features
                $('.commands .button').click(function() {
                    var pressed = $(this).hasClass('pressed');

                    if(arte.activeFeature != '') {
                        message = arte.getMessage();
                        mqttClient.pub(message, 'daily');
                    }

                    if( pressed ) {
                        arte.stopFeature();
                        $(this).removeClass('pressed');
                    } else {
                        $('.commands .button').removeClass('pressed');
                        $(this).addClass('pressed');
                    }
                });


                // This event is triggered when a new marker is recognized
                // We should show artwork's informations
                $('body').on( 'markerFound', function(e) {
                    arte.artworkRecognized = 1;
                    arte.artworkID = 1;

                    function printObject(o) {
                      var out = '';
                      for (var p in o) {
                        out += p + ': ' + o[p] + '\n';
                      }
                      alert(out);
                    }

                    printObject(e);
                    printObject(this);

                    // TODO recognize which marker has been detected


                    $('.commands').css('bottom', 0);
                    $('#artwork').toggle();
                });




                // This event is triggered when a new marker is no more recognized
                $('body').on( 'markerLost', function() {
                    arte.artworkRecognized = 0;

                    $( '#color-box' ).css( 'opacity', '0');
                    $( '#color-box-2' ).css( 'opacity', '0');
                    $('.commands').css('bottom', '-22vw');
                    $('#artwork').toggle();

                    clearInterval( light_event );
                });

            });


            // Light gradient with intensity values
            function light_func() {
                var v = $('#light').attr('light').intensity;
                if( dir == 1 ) {
                    v -= 0.01;
                } else {
                    v += 0.01;
                }

                if( v == 0 ) {
                    dir = 0;
                } else if( v == 0.99 ) {
                    dir = 1;
                }

                $('#light').attr('light', 'intensity: ' + v.toFixed(2) );
                $('#light2').attr('light', 'intensity: ' + (1 - v).toFixed(2) );
            }


            // Change color and rotation degree of baground gradient based on room values
            // Change light colors based on room values
            function color_func() {
                for( i = 0; i < rooms.length; i++ ) {
                    rooms[i] = rooms[i] + ( ( Math.round( Math.random() ) * 5 ) * Math.random() ) + ( ( Math.round( Math.random() ) * -5 ) * Math.random() );
                }

                for( i = 0; i < 6; i++ ) {
                    colors[i] = 0;
                    for( j = 0; j < Math.floor( rooms.length / 6 ); j++ ) {
                        colors[i] += rooms[i+(j*6)];
                    }
                }

                for(var i = 0; i < colors.length; i++) {
                    colors[i] = Math.max( Math.min( ( colors[i] * 255 / ( 30*mult ) ) + ( 20*i ), 255 ), 0 );
                }

                for(var i = 0; i < 3; i++) {
                    lights[i] = Math.max( Math.min( parseInt( ( ( colors[i] /* + colors[i+3] */ ) ) - 20 ), 255 ), 0 );
                }

                deg = ( rooms.reduce( function( a, b ) { return a + b; }, 0 ) % ( 30*rooms.length ) ) * 360 / ( 30*rooms.length );


                if( time % 2 == 1 ) {
                    $( '#light2' ).attr( 'color', 'rgb(' + lights[0] + ',' + lights[1] + ',' + lights[2] + ')' );
                    $( '#color-box' ).css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );
                    $( '#color-box' ).css( 'opacity', '1');
                } else {
                    $( '#light' ).attr( 'color', 'rgb(' + lights[0] + ',' + lights[1] + ',' + lights[2] + ')' );
                    $( '#color-box-2' ).css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );
                    $( '#color-box' ).css( 'opacity', '0');
                }

                time = time + 1;
            }
        </script>
    </body>
</html>
