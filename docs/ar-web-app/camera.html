<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>ARte</title>
        
        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="./css/style.css">

        <!-- AR libs -->
        <script src="./js/aframe-master.min.js"></script>
        <script src="./js/aframe-ar-nft.js"></script>
        
        <!-- Utility -->
        <script src="./js/aws.js"></script>
        <script src="./js/pahoMQTTClient.js"></script>
        <script src="./js/utils.js"></script>
        
        <!-- External libs -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script> 
        <script src="./js/jquery-3.5.1.min.js"></script>   
        
        <!-- ARte js library -->
        <script src="./js/ARte.js"></script>
    </head>
    <body>
        <!-- Header -->
        <header>
            <a href="">
                <img src="./img/logo.png" alt="logo">
            </a>
        </header>

        <!-- Minimal loader shown until image descriptors are loaded -->
        <div class="arjs-loader">
            <div>Loading, please wait...</div>
        </div>

        <!-- Artwork description -->
        <div id="artwork" hidden>
            <div class="title">Discobolus</div>
        </div>

        <!-- Info popup -->
        <div id="info" hidden>
            <p></p>
        </div>

        <!-- Features panel -->
        <div class="commands">
           <div class="button">
                <img src="./img/icons/animation.svg" alt="Animation">
            </div>
            <div class="button">
                <img src="./img/icons/contextualization.svg" alt="Contextualization">
            </div>
            <div class="button">
                <img src="./img/icons/camera.svg" alt="Camera">
            </div>
            <div class="button">
                <img src="./img/icons/rebuilding.svg" alt="Rebuilding">
            </div>
            <div class="button" id="play">
                <img src="./img/icons/storytelling.svg" alt="Storytelling">
            </div>
        </div>

        <!-- AR core -->
        <a-scene
            vr-mode-ui='enabled: false;'
            renderer="logarithmicDepthBuffer: true;"
            embedded arjs='trackingMethod: best; sourceType: webcam; debugUIEnabled: false;'>

            <!-- use rawgithack to retrieve the correct url for nft marker (see 'pinball' below) -->
            <a-nft type='nft' url='https://arte-team.github.io/ARte/ar-web-app/img/markers/1' smooth='true' smoothCount='10' smoothTolerance='0.01' smoothThreshold='5'>
                <a-entity
                    gltf-model='./models/scene.gltf'
                    scale="0.15 0.15 0.15"
                    position="100 -50 50"
                    rotation="-90 0 0"
                    >
                </a-entity>
            </a-nft>
            <a-entity camera></a-entity>
        </a-scene>

        <script>
            
            
            // Set unique deviceID for the user
            // Check if cookie is already present
            var uuid;
            
            if(accessCookie("deviceID") == '') {
                uuid = createUUID();
                createCookie("deviceID", uuid, 12);
            } else {
                uuid = accessCookie("deviceID");
            }
            
            var mqttClient = null;
            
            function onConnect() {}

            // Initialize Amazon Cognito credentials provider
            AWS.config.region      = 'us-east-1';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
              IdentityPoolId: 'us-east-1:73b2cfba-525a-4f90-ba69-2c4ca9de375a',
            });

            // Obtain credentials
            AWS.config.credentials.get(function(){
              // Credentials will be available when this function is called
              var host       = 'a38agfpa1egwwp-ats.iot.us-east-1.amazonaws.com';
              var requestUrl = SigV4Utils.getSignedUrl(host, AWS.config.region, AWS.config.credentials);
              mqttClient     = new PahoMQTTClient(requestUrl, uuid);
              mqttClient.conn(onConnect);
            });
            
            
            
            
            // Initialize audio for storytelling
            var audioElement = document.createElement('audio');
            audioElement.setAttribute('src', './audio/1.mp3');
            
            
            // Initialize ARte object for feature interaction
            var arte = new ARte(uuid);  
            
            var message = '';
            
            
            // Send message to broker when browser is idle mode
            // Set visibilitychange event listener
            function sendMessageIdle() {
                if (document.hidden) {
                    audioElement.pause();
                    message = arte.getMessage();
                    mqttClient.pub(message, 'daily');
                    arte.stopFeature();
                    
                    $('.commands .button').removeClass('pressed');
                } else  {
                    /*audioElement.play();
                    startFeature();*/
                }
            }
            document.addEventListener( 'visibilitychange', sendMessageIdle, false);       
            

            $(document).ready(function() {
                
                // Storytelling manager
                $('#play').click(function() {
                    var status = arte.featureAttributes.status;
                    
                    if( status == 2 ) {
                        audioElement.pause();
                        arte.featureAttributes.status = 1;
                    } else if( status < 2 ) {
                        audioElement.play();
                        arte.featureAttributes.status = 2;
                    }
                });

                
                // Changing style to buttons when pressed
                // Start and stop features
                $('.commands .button').click(function() {
                    var pressed = $(this).hasClass('pressed');
                    
                    if(arte.activeFeature != '') {
                        message = arte.getMessage();
                        mqttClient.pub(message, 'daily');
                    }
                    arte.startFeature('storytelling');
                    
                    if( pressed ) {
                        arte.stopFeature();
                        $(this).removeClass('pressed');
                    } else {
                        $('.commands .button').removeClass('pressed');
                        $(this).addClass('pressed');
                    }
                });


                // This event is triggered when a new marker is recognized
                // We should show artwork's informations
                $('body').on( 'markerFound', function() {
                    arte.artworkRecognized = 1;
                    arte.artworkID = 1;
                    
                    $('.commands').css('bottom', 0);
                    $('#artwork').toggle();
                });

                
                // This event is triggered when a new marker is no more recognized
                $('body').on( 'markerLost', function() {
                    arte.artworkRecognized = 0;
                    
                    $('#artwork').toggle();
                });


            });
        </script>
    </body>
</html>
