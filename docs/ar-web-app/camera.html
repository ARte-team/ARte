<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>ARte</title>
        
        <link rel="stylesheet" type="text/css" href="./css/style.css">

        <script src="./js/aframe-master.min.js"></script>
        <script src="./js/aframe-ar-nft.js"></script>
        <script src="./js/jquery-3.5.1.min.js"></script>
        
        <script src="./js/aws.js"></script>
        <script src="./js/pahoMQTTClient.js"></script>
        <script src="./js/utils.js"></script>
        
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

        
    </head>
    <body>
        <header>
            <a href="">
                <img src="./img/logo.png" alt="logo">
            </a>
        </header>

        <!-- Minimal loader shown until image descriptors are loaded -->
        <div class="arjs-loader">
            <div>Loading, please wait...</div>
        </div>

        <!-- Artwork description -->
        <div id="artwork" hidden>
            <div class="title">Discobolus</div>
        </div>

        <div id="info" hidden>
            <p></p>
        </div>

        <div class="commands">
           <div class="button">
                <img src="./img/icons/animation.svg" alt="Animation">
            </div>
            <div class="button">
                <img src="./img/icons/contextualization.svg" alt="Contextualization">
            </div>
            <div class="button">
                <img src="./img/icons/camera.svg" alt="Camera">
            </div>
            <div class="button">
                <img src="./img/icons/rebuilding.svg" alt="Rebuilding">
            </div>
            <div class="button" id="play">
                <img src="./img/icons/storytelling.svg" alt="Storytelling">
            </div>
        </div>

        <a-scene
            vr-mode-ui='enabled: false;'
            renderer="logarithmicDepthBuffer: true;"
            embedded arjs='trackingMethod: best; sourceType: webcam; debugUIEnabled: false;'>

            <!-- use rawgithack to retrieve the correct url for nft marker (see 'pinball' below) -->
            <a-nft type='nft' url='https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/trex-image/trex' smooth='true' smoothCount='10' smoothTolerance='0.01' smoothThreshold='5'>
                <a-entity
                    gltf-model='./models/scene.gltf'
                    scale="0.15 0.15 0.15"
                    position="100 0 50"
                    rotation="-90 0 0"
                    >
                </a-entity>
            </a-nft>
            <a-entity camera></a-entity>
        </a-scene>

        <script>
            var uuid;
            
            // Set cookie with deviceID if not present yet
            if(accessCookie("deviceID") == "") {
                uuid = createUUID();
                createCookie("deviceID", uuid, 12);
            } else {
                uuid = accessCookie("deviceID");
            }
            
            var mqttClient = null;

            // Initialize Amazon Cognito credentials provider
            AWS.config.region      = '';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
              IdentityPoolId: '',
            });

            // Obtain credentials
            AWS.config.credentials.get(function(){
              // Credentials will be available when this function is called
              var host       = "";
              var requestUrl = SigV4Utils.getSignedUrl(host, AWS.config.region, AWS.config.credentials);
              mqttClient     = new PahoMQTTClient(requestUrl, uuid);
              mqttClient.conn(onConnect);//, callbackReceive);
            });
            
            
            // Status: 0 -> Stopped, 1 -> Paused, 2 -> Playing
            var storytellingStatus = 0;

            // Features
            var activeFeature = '';

            // Recognized artwork?
            var artworkRecognized = 0;
            
            // Message for broker
            var message = {
                deviceID: uuid,
                datetime: '',
                feature: '',
                usageTime: '',
                artworkID: ''
            }
            
            var startTime = 0;
            
            
            // Initialize audio for storytelling
            var audioElement = document.createElement('audio');
            audioElement.setAttribute('src', 'http://www.soundjay.com/misc/sounds/bell-ringing-01.mp3');
            audioElement.addEventListener('ended', function() {
                this.play();
            }, false);
            
            
            
            
            function onConnect() {
                
            }
            
            
            //startSimulation and pauseSimulation defined elsewhere
            function handleVisibilityChange() {
                if (document.hidden) {
                    audioElement.pause();
                    sendMessage();
                    stopFeature();
                    $('.commands .button').removeClass('pressed');
                } else  {
                    /*audioElement.play();
                    startFeature();*/
                }
            }

            document.addEventListener("visibilitychange", handleVisibilityChange, false);       
            
            // When a feature button is pressed, message is filled in the correct way
            function startFeature() {
                message['feature'] = 'storytelling';
                startTime = Date.now();
            }
            
            // When phone is idle or feature is deactivated, stop the execution
            function stopFeature() {
                message['feature'] = '';
                startTime = 0;
            }
            
            // Function triggered at the end of a feature
            function sendMessage() {
                if(startTime > 0) {
                    var stopTime = Date.now();
                    message['usageTime'] = (stopTime - startTime) / 1000;
                    message['datetime'] = stopTime;
                    mqttClient.pub(JSON.stringify(message), "daily");
                }
            }
            
            
            
            
            
            
            

            

            $(document).ready(function() {
                
                $('#play').click(function() {
                    if( storytellingStatus == 2 ) {
                        audioElement.pause();
                        storytellingStatus = 1;
                    } else if( storytellingStatus < 2 && artworkRecognized == 1 ) {
                        audioElement.play();
                        storytellingStatus = 2;
                    }
                });

                // Changing style to buttons when pressed
                $('.commands .button').click(function() {
                    if(artworkRecognized) {
                        var pressed = $(this).hasClass('pressed');
                        sendMessage();
                        startFeature();
                        if( pressed ) {
                            activeFeature = '';
                            startTime = 0;
                            $(this).removeClass('pressed');
                        } else {
                            $('.commands .button').removeClass('pressed');
                            $(this).addClass('pressed');
                        }
                    } else {
                        $('#info p').html('No artwork recognized!');
                        $('#info').toggle();
                        console.log('No artwork recognized!');
                    }
                });


                // This event is triggered when a new marker is recognized
                // We should show artwork's informations
                $('body').on( "markerFound", function() {
                    artworkRecognized = 1;
                    message['artworkID'] = 1;
                    $('.commands').css('bottom', 0);
                    $('#artwork').toggle();
                    $('#info').show().delay(3000).fadeOut();
                });

                // This event is triggered when a new marker is no more recognized
                $('body').on( "markerLost", function() {
                    artworkRecognized = 0;
                    $('.commands').css('bottom', '-22vw');
                    $('#artwork').toggle();
                });


            });

            // Selector for functions
            function toggleFunction() {

            }
        </script>
    </body>
</html>
