<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <!--<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">-->
        <meta name="description" content="ARte web app">
        <meta name="keywords" content="">
        <meta name="author" content="ARte team">
        <title>ARte</title>

        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="./css/style.css">

        <!-- AR libs -->
        <script src="./js/aframe-master.min.js"></script>
        <script src="./js/aframe-ar-nft.js"></script>

        <!-- Utility -->
        <script src="./js/aws.js"></script>
        <script src="./js/pahoMQTTClient.js"></script>
        <script src="./js/utils.js"></script>

        <!-- External libs -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
        <script src="./js/jquery-3.5.1.min.js"></script>

        <!-- ARte js library -->
        <script src="./js/ARte.js"></script>
        <script src="./js/gesture-detector.js"></script>
        <script src="./js/gesture-handler.js"></script>
    </head>
    <body class="page-camera">
        <!-- Header -->
        <header>
            <a href="">
                <img src="./img/logo_white.png" alt="logo">
            </a>
        </header>

        <!-- Minimal loader shown until image descriptors are loaded -->
        <div class="arjs-loader">
            <div>Loading, please wait...</div>
        </div>

        <!-- Artwork description -->
        <div id="artwork" hidden>
            <div class="title">Discobolus</div>
        </div>

        <!-- Info popup -->
        <div id="info" hidden>
            <p></p>
        </div>

        <!-- Features panel -->
        <div class="commands">
            <div class="button" id="color">
                <img src="./img/icons/palette.svg" alt="Color">
            </div>
            <div class="button" id="music">
                <img src="./img/icons/note.svg" alt="Music">
            </div>
        </div>


        <!-- Color animation box -->
        <div id="color-box"></div>
        <div id="color-box-2"></div>

        <!-- AR core -->
        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            gesture-detector
            embedded
            id="scene">

            <!-- use rawgithack to retrieve the correct url for nft marker (see 'pinball' below) -->
            <a-nft type='nft'
                   url='https://arte-team.github.io/ARte/ar-web-app/img/markers/1'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'>
                <a-entity
                    gltf-model='./models/scene.gltf'
                    scale="0.15 0.15 0.15"
                    position="50 50 0"
                    rotation="-90 0 0"
                    id="model"
                    gesture-handler="minScale: 0.25; maxScale: 10">
                </a-entity>
            </a-nft>
            <a-entity camera></a-entity>
        </a-scene>

        <script>


            // Set unique deviceID for the user
            // Check if cookie is already present
            var uuid;

            if(accessCookie("deviceID") == '') {
                uuid = createUUID();
                createCookie("deviceID", uuid, 12);
            } else {
                uuid = accessCookie("deviceID");
            }

            var mqttClient = null;

            function onConnect() {}

            // Initialize Amazon Cognito credentials provider
            AWS.config.region      = '';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
              IdentityPoolId: '',
            });


            // Obtain credentials
            AWS.config.credentials.get(function(){
              // Credentials will be available when this function is called
              var host       = '';
              var requestUrl = SigV4Utils.getSignedUrl(host, AWS.config.region, AWS.config.credentials);
              mqttClient     = new PahoMQTTClient(requestUrl, uuid);
              mqttClient.conn(onConnect);
            });


            // Initialize ARte object for feature interaction
            var arte = new ARte(uuid);

            var message = '';


            // Send message to broker when browser is idle mode
            // Set visibilitychange event listener
            function sendMessageIdle() {
                if (document.hidden) {
                    audioElement.pause();
                    message = arte.getMessage();
                    mqttClient.pub(message, 'daily');
                    arte.stopFeature();

                    $('.commands .button').removeClass('pressed');
                } else  {
                    /*audioElement.play();
                    startFeature();*/
                }
            }

            document.addEventListener( 'visibilitychange', sendMessageIdle, false );


            // Scale model when double finger gesture is detected
            function handleScale( event ) {
                var model = document.getElementById( "model" );
                var scaleFactor = Math.min( Math.max( 2, 0.25 ), 10 );

                model.object3D.scale.x = scaleFactor * initialScale.x;
                model.object3D.scale.y = scaleFactor * initialScale.y;
                model.object3D.scale.z = scaleFactor * initialScale.z;
            }

            // Rotate model when one finger gesture is detected
            function handleRotation(event) {
                var el = document.getElementById( "model" );
                var rotationFactor = 2;

                el.object3D.rotation.y += event.detail.positionChange.x * rotationFactor;
                el.object3D.rotation.x += event.detail.positionChange.y * rotationFactor;
            }

            var sceneEl = document.getElementById( "scene" );
            sceneEl.addEventListener( 'onefingermove', handleRotation );
            sceneEl.addEventListener( 'twofingermove', handleScale );


            // Background gradient simulation
            var rooms = [10, 4, 2, 5, 15, 3, 2, 10, 5, 6, 8, 8, 20, 1, 0, 13, 7, 9, 10];
            var colors = []
            for( i = 0; i < 6; i++ ) {
                colors[i] = 0;
                for( j = 0; j < Math.floor( rooms.length / 6 ); j++ ) {
                    colors[i] += rooms[i+(j*6)];
                }
            }

            var mult = Math.floor( rooms.length / 6 );

            for(var i = 0; i < colors.length; i++)
                colors[i] = Math.min( ( rooms[i] * 255 / ( 30*mult ) ) + ( 20*i ), 255 );

            var deg = ( rooms.reduce( function( a, b ) { return a + b; }, 0 ) % ( 30*rooms.length ) ) * 360 / ( 30*rooms.length );
            var color_event = 0;
            var time = 0;


            $( document ).ready(function() {

                $( '#color-box' ).css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );


                // Color manager
                $('#color').click(function() {
                    var status = arte.featureAttributes.status;

                    if( status == 0 ) {
                        $( '#color-box' ).css( 'opacity', '1');
                        $( '#color-box-2' ).css( 'opacity', '1');
                        color_event = setInterval( color, 1500 );
                        arte.featureAttributes.status = 1;
                    } else if( status == 1 ) {
                        $( '#color-box' ).css( 'opacity', '0');
                        $( '#color-box-2' ).css( 'opacity', '0');
                        clearInterval( color_event );
                        arte.featureAttributes.status = 0;
                    }
                });


                // Music manager
                $('#music').click(function() {
                    var status = arte.featureAttributes.status;

                    if( status == 0 ) {

                        arte.featureAttributes.status = 1;
                    } else if( status == 1 ) {

                        arte.featureAttributes.status = 0;
                    }
                });


                // Changing style to buttons when pressed
                // Start and stop features
                $('.commands .button').click(function() {
                    var pressed = $(this).hasClass('pressed');

                    if(arte.activeFeature != '') {
                        message = arte.getMessage();
                        mqttClient.pub(message, 'daily');
                    }

                    if( pressed ) {
                        arte.stopFeature();
                        $(this).removeClass('pressed');
                    } else {
                        $('.commands .button').removeClass('pressed');
                        $(this).addClass('pressed');
                    }
                });


                // This event is triggered when a new marker is recognized
                // We should show artwork's informations
                $('body').on( 'markerFound', function() {
                    arte.artworkRecognized = 1;
                    arte.artworkID = 1;

                    $('.commands').css('bottom', 0);
                    $('#artwork').toggle();
                });


                // This event is triggered when a new marker is no more recognized
                $('body').on( 'markerLost', function() {
                    arte.artworkRecognized = 0;

                    $('.commands').css('bottom', '-22vw');
                    $('#artwork').toggle();
                });

            });


            // Change color and rotation degree of baground gradient based on room values
            function color() {
                for( i = 0; i < rooms.length; i++ )
                    rooms[i] = rooms[i] + ( ( Math.round( Math.random() ) * 5 ) * Math.random() ) + ( ( Math.round( Math.random() ) * -5 ) * Math.random() );

                for( i = 0; i < colors.length; i++ )
                    colors[i] = Math.min( ( rooms[i] * 255 / ( 30*mult ) ) + ( 20*i ), 255 );

                var deg = ( rooms.reduce( function( a, b ) { return a + b; }, 0 ) % ( 30*rooms.length ) ) * 360 / ( 30*rooms.length );

                if( time % 2 == 0 ) {
                    $( '#color-box' ).css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );
                    $( '#color-box' ).css( 'opacity', '1');
                } else {
                    $( '#color-box-2' ).css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );
                    $( '#color-box' ).css( 'opacity', '0');
                }

                time = time + 1;
            }
        </script>
    </body>
</html>
