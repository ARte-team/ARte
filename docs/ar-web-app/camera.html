<!DOCTYPE html>
<html lang="en">
    <head>
        <title>ARte</title>

        <!-- Meta -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="ARte web app">
        <meta name="keywords" content="">
        <meta name="author" content="ARte team">

        <!-- Favicon icon -->
        <link rel="icon" href="../Dashboard/files/assets/images/arte_icon.png" type="image/x-icon">

        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="./css/style.css">

        <!-- AR libs -->
        <script src="./js/aframe-master.min.js"></script>
        <script src="./js/aframe-ar-nft.js"></script>

        <!-- Utility -->
        <script src="./js/aws.js"></script>
        <script src="./js/pahoMQTTClient.js"></script>
        <script src="./js/utils.js"></script>

        <!-- External libs -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
        <script src="./js/jquery-3.5.1.min.js"></script>
        <script src="./js/Tone.js"></script>
        <!--<script src="./js/tone-ui.js"></script>-->
        <script src="./js/components.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>

        <!-- ARte js library -->
        <script src="./js/ARte.js"></script>
        <script src="./js/gesture-detector.js"></script>
    </head>
    <body class="page-camera">
        <!-- Header -->
        <header>
            <a href="">
                <img src="./img/logo_white.png" alt="Logo">
            </a>
            <a href="./map.html">
                <img id="map" src="./img/icons/map.svg" alt="Map">
            </a>
        </header>

        <!-- Minimal loader shown until image descriptors are loaded -->
        <div class="arjs-loader">
            <div>Loading, please wait...</div>
        </div>

        <!-- Artwork title -->
        <div id="artworkTitle" hidden></div>

        <!-- Artwork information -->
        <div id="artworkInfo" hidden></div>
        <!--<div id="artworkInfo"><b>Discobolus</b><br><br> Discobolus of Myron ...</div>-->

        <!-- Features panel -->
        <div class="commands">
            <div class="button" id="color">
                <img src="./img/icons/palette.svg" alt="Color">
            </div>
            <div class="button" id="music">
                <img src="./img/icons/note.svg" alt="Music">
            </div>
            <div class="button" id="storytelling">
                <img src="./img/icons/storytelling.svg" alt="Storytelling">
            </div>
            <div class="button" id="contextualization">
                <img src="./img/icons/contextualization.svg" alt="Contextualization">
            </div>
        </div>

        <!-- Artwork information button -->
        <div id="info" hidden>
          <img src="./img/icons/info.svg" alt="Artwork information">
        </div>

        <!-- Fix artwork button -->
        <!--<div id="fix-artwork-button" hidden>
          <img src="./img/icons/lock.svg" alt="Fix">
        </div>-->

        <!-- Color animation box -->
        <div id="color-box-1"></div>
        <div id="color-box-2"></div>

        <!-- Contextualization box -->
        <div id="contextualization-box"></div>


        <!-- AR core -->
        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            gesture-detector
            embedded
            id="scene">

            <a-nft type='nft'
                   url='https://arte-team.github.io/ARte/ar-web-app/img/markers/Artemision Bronze/Artemision Bronze'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'
                   id="3ecdcfe1-c596-46e6-9a29-de443dd80638"
                   title="Artemision Bronze">
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelArtemisionBronze"
                         light="intensity: 1;"
                         id="lightArtemisionBronze_1">
                </a-light>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelArtemisionBronze"
                         light="intensity: 0;"
                         id="lightArtemisionBronze_2">
                </a-light>

                <a-entity
                  position="110 -50 -100"
                  rotation="-90 0 0">
                  <a-entity
                      gltf-model='https://arte-team.github.io/ARte/Dashboard/files/assets/uploads/models/Artemision Bronze/scene.gltf'
                      scale="0.1 0.1 0.1"
                      gesture-handler="minScale: 0.25; maxScale: 5"
                      id="modelArtemisionBronze" >
                  </a-entity>
                </a-entity>
            </a-nft>

            <a-nft type='nft'
                   url='https://arte-team.github.io/ARte/ar-web-app/img/markers/Athena of Velletri/Athena of Velletri'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'
                   id="3ccb3d2c-84a2-43b0-aedf-d34c98c4f855"
                   title="Athena of Velletri">
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelAthenaOfVelletri"
                         light="intensity: 1;"
                         id="lightAthenaOfVelletri_1">
                </a-light>
                <a-light type="directional"
                         position="0 0 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelAthenaOfVelletri"
                         light="intensity: 0;"
                         id="lightAthenaOfVelletri_2">
                </a-light>

                <a-entity
                  position="120 -50 -100"
                  rotation="-90 0 0">
                  <a-entity
                      gltf-model='https://arte-team.github.io/ARte/Dashboard/files/assets/uploads/models/Athena of Velletri/scene.gltf'
                      scale="50 50 50"
                      gesture-handler="minScale: 0.25; maxScale: 5"
                      id="modelAthenaOfVelletri">
                  </a-entity>
                </a-entity>
            </a-nft>

            <a-nft type='nft'
                   url='https://arte-team.github.io/ARte/ar-web-app/img/markers/Discobolus/Discobolus'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'
                   id="12497814-467c-4d4b-adf9-25c628ac531f"
                   title="Discobolus">
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelDiscobolus"
                         light="intensity: 1;"
                         id="lightDiscobolus_1">
                </a-light>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelDiscobolus"
                         light="intensity: 0;"
                         id="lightDiscobolus_2">
                </a-light>

                <a-entity
                  position="80 -20 -100"
                  rotation="-90 0 0">
                  <a-entity
                      gltf-model='https://arte-team.github.io/ARte/Dashboard/files/assets/uploads/models/Discobolus/scene.gltf'
                      scale="0.15 0.15 0.15"
                      gesture-handler="minScale: 0.5; maxScale: 5"
                      id="modelDiscobolus">
                  </a-entity>
                </a-entity>
            </a-nft>

            <a-nft type='nft'
                   url='https://arte-team.github.io/ARte/ar-web-app/img/markers/Lion Gate of Mycenae/Lion Gate of Mycenae'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'
                   id="ea090a5e-ba32-45b0-8d48-05cdf584d8b3"
                   title="Lion Gate of Mycenae">
                <a-light type="directional"
                         position="0 100 100"
                         rotation="0 0 0"
                         color="#FFFFFF"
                         target="#directionaltargetLionGateOfMycenae"
                         light="intensity: 2;"
                         id="lightLionGateOfMycenae_1">
                    <a-entity id="directionaltargetLionGateOfMycenae" position="0 -50 0"></a-entity>
                </a-light>
                <a-light type="directional"
                         position="0 100 100"
                         rotation="0 0 0"
                         color="#FFFFFF"
                         target="#directionaltargetLionGateOfMycenae"
                         light="intensity: 0;"
                         id="lightLionGateOfMycenae_2">
                </a-light>

                <a-entity
                  position="120 -50 -200"
                  rotation="-90 0 0">
                  <a-entity
                      gltf-model='https://arte-team.github.io/ARte/Dashboard/files/assets/uploads/models/Lion Gate of Mycenae/scene.gltf'
                      scale="30 30 30"
                      gesture-handler="minScale: 0.25; maxScale: 5"
                      id="modelLionGateOfMycenae">
                  </a-entity>
                </a-entity>
            </a-nft>

            <a-nft type='nft'
                   url='https://arte-team.github.io/ARte/ar-web-app/img/markers/Nike of Samothrace/Nike of Samothrace'
                   smooth='true'
                   smoothCount='10'
                   smoothTolerance='0.01'
                   smoothThreshold='5'
                   id="f4f54716-6d0f-4e7d-8eac-7430c77087ec"
                   title="Nike of Samothrace">
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelNikeOfSamothrace"
                         light="intensity: 3;"
                         id="lightNikeOfSamothrace_1">
                </a-light>
                <a-light type="directional"
                         position="0 100 0"
                         rotation="0 0 0"
                         color="#FFF"
                         target="#modelNikeOfSamothrace"
                         light="intensity: 0;"
                         id="lightNikeOfSamothrace_2">
                </a-light>

                <a-entity
                  position="120 -30 -80"
                  rotation="-90 0 0">
                  <a-entity
                      gltf-model='https://arte-team.github.io/ARte/Dashboard/files/assets/uploads/models/Nike of Samothrace/scene.gltf'
                      scale="5 5 5"
                      gesture-handler="minScale: 0.25; maxScale: 5"
                      id="modelNikeOfSamothrace">
                  </a-entity>
                </a-entity>
            </a-nft>

            <a-entity camera></a-entity>
        </a-scene>

        <script>
            // Set unique deviceID for the user
            // Check if cookie is already present
            let uuid;

            if(accessCookie("deviceID") === "") {
                uuid = createUUID();
                createCookie("deviceID", uuid, 12);
            } else {
                uuid = accessCookie("deviceID");
            }

            let conn = null;
            let flag = 0;
            let current_room = 1;

            // Arrays for the museum data
            var rooms = [10, 4, 12, 5, 15, 3, 2, 10, 5, 16, 8, 8, 20, 1, 0, 13, 7, 9];
            var sensors = [[12.0, 13.6, 17.3], [14.5, 11.9, 3.8], [14.2, 12.1, 11.0], [0.7, 8.8, 2.3], [9.5, 7.2, 0.2], [4.3, 4.7, 0.4], [17.9, 17.2, 10.8], [11.3, 12.6, 13.2], [11.0, 14.2, 12.0], [9.3, 6.4, 9.0], [3.5, 3.6, 9.1], [0.3, 2.9, 5.2], [2.4, 8.5, 19.5], [18.2, 10.2, 20.0], [9.5, 4.5, 19.8], [3.2, 16.5, 9.7], [8.3, 9.6, 1.0], [0.3, 19.8, 2.9]];


            function onConnect() {
              conn = mqttClient.isConn();
              if (!conn)
                alert("Error while loading the page. Try to refresh it!");
              else
                mqttClient.sub("sensor/room");
            }

            function onReceive(msg) {
              if(conn) {
                msg = JSON.parse(msg);
                if(msg.roomID != 0) {
                  current_room = msg.roomID;
                  /*if(!flag){
                    rooms   = [];
                    sensors = [];
                    flag = 1;
                  }*/
                  for(let i = 0; i < current_room; i++){
                    if(rooms.length < current_room){
                      rooms.push(0);
                      sensors.push([]);
                    }
                    else
                      break;
                  }
                  rooms[current_room - 1]   = msg.peopleCurrent;
                  sensors[current_room - 1] = (msg.infraredValues).map(x => parseInt(x));
                }
              } else {
                alert("Connection error. Try to refresh the page!");
              }
            }

            let mqttClient = null;

            // Initialize Amazon Cognito credentials provider
            AWS.config.region      = 'us-east-1';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
              IdentityPoolId: 'us-east-1:33cfdc7c-d841-41cb-b3b4-af3b015348da'
            });

            // Obtain credentials
            AWS.config.credentials.get(function(){
              // Credentials will be available when this function is called
              const host       = 'a194ad8wufud1k-ats.iot.us-east-1.amazonaws.com';
              const requestUrl = SigV4Utils.getSignedUrl(host, AWS.config.region, AWS.config.credentials);
              mqttClient       = new PahoMQTTClient(requestUrl, uuid);
              mqttClient.conn(onConnect, onReceive);
            });


            // Initialize ARte object for feature interaction
            const arte = new ARte(uuid);

            // MQTT topic
            const topic = "smartphone";

            // Map to store information about (artwork, newView) pairs
            const newViewsMap = new Map();

            // Function to call when a feature is stopped
            function sendMessage() {
                const message = arte.getMessage();
                if (!message)
                  return;

                mqttClient.pub(JSON.stringify(message), topic);

                newViewsMap.set(message.artworkID, false);
                arte.setNewView(false);

                //alert("newView in send message: " + arte.newView);
                //alert("newViewsMap.has(" + message.artworkID + "): " + newViewsMap.has(message.artworkID));
            }

            // Music generation
            var APP = {};
            var SEED = sensors[current_room-1].reduce( function( a, b ) { return a + b; }, 0 );

            // Create a synth and connect it to the main output (your speakers)
            const synth = new Tone.Synth().toDestination();

            // Initialize storytelling feature
            const audioElement = document.createElement('audio');

            // Background gradient simulation
            var colors = [];
            var lights = [];

            var mult = Math.floor( rooms.length / 3 );      // Multiplicator for background colors and lights value calculation
            var time = 0;                                   // Clock for background gradient
            var dir = 1;                                    // Light gradient direction
            var deg = 0;                                    // Grandient inclination degree

            var color_event;
            var light_event;

            for( i = 0; i < 6; i++ ) {
                colors[i] = 0;
                for( j = 0; j < Math.floor( rooms.length / 6 ); j++ ) {
                    colors[i] += rooms[i+(j*6)];
                }

            }

            for( i = 0; i < 3; i++ ) {
                lights[i] = 0;
                for( j = 0; j < Math.floor( rooms.length / 3 ); j++ ) {
                    lights[i] += Math.round( sensors[i+(j*3)][0] + sensors[i+(j*3)][1] + sensors[i+(j*3)][2] );
                }
            }

            for( i = 0; i < lights.length; i++ ) {
                lights[i] = Math.max( Math.min( ( colors[i] + Math.ceil( lights[i] * 50 / ( 60*mult ) ) ), 255 ), 0 );
            }

            for( i = 0; i < colors.length; i++ ) {
                colors[i] = Math.max( Math.min( ( colors[i] * 255 / ( 20*mult/2 ) ) + ( ( -1+(2*(i%2)) ) * ( lights[i%3] * 30 / ( 60*mult ) ) ), 255 ), 0 );
            }

            deg = ( lights.reduce( function( a, b ) { return a + b; }, 0 ) - rooms.reduce( function( a, b ) { return a + b; }, 0 ) ) * 360 / ( 60*mult );


            // Lights of the recognized artwork
            let light1 = null;
            let light2 = null;

            // Variables for the gestures (scale and rotation)
            let artworkModel = null;
            let initialModelScale    = null;
            let initialModelRotation = null;

            // Variable to lock the orientation of the device
            /*let orientationLocked = false;

            // Lock portrait orientation (in fullscreen mode artworks are distorted)
            async function lockOrientation() {
              if (orientationLocked)  return;

              orientationLocked = true;
              await document.body.requestFullscreen();
              await window.screen.orientation.lock("portrait");
            }*/

            // Show a message when landscape mode
            window.addEventListener("orientationchange", function() {
              if (screen.orientation.angle == 90 || screen.orientation.angle == 270)
                alert("For a better experience we suggest to use the web app in portrait mode");
            });


            $( document ).ready(function() {
                const sceneEl = document.getElementById("scene");

                // Gesture constants
                let scaleFactor      = 2;
                const rotationFactor = 120;

                // Scale model when double finger gesture is detected
                function handleScale( event ) {
                    scaleFactor *= 1 + event.detail.spreadChange / event.detail.startSpread;
                    scaleFactor = Math.min( Math.max( scaleFactor, 0.5 ), 5 );

                    artworkModel.object3D.scale.x = scaleFactor * initialModelScale.x;
                    artworkModel.object3D.scale.y = scaleFactor * initialModelScale.y;
                    artworkModel.object3D.scale.z = scaleFactor * initialModelScale.z;
                }

                // Rotate model when one finger gesture is detected
                function handleRotation( event ) {
                    const dx = event.detail.positionChange.x;
                    //const dy = event.detail.positionChange.y;

                    //artworkModel.object3D.rotation.y += dx * rotationFactor;
                    //artworkModel.object3D.rotation.x += dy * rotationFactor;

                    const rot = artworkModel.getAttribute("rotation");
                    rot.y += dx * rotationFactor;
                    //rot.x += dy * rotationFactor;
                    artworkModel.setAttribute("rotation", rot);
                }

                sceneEl.addEventListener( 'onefingermove', handleRotation );
                sceneEl.addEventListener( 'twofingermove', handleScale );


                // Get HTML elements
                const artworkTitle = $('#artworkTitle');
                const artworkInfo  = $('#artworkInfo');

                //const fixArtwork = $('#fix-artwork-button');
                const infoBtn = $('#info');

                // functionalities buttons
                const colorBtn             = $('#color');
                const musicBtn             = $('#music');
                const storytellingBtn      = $('#storytelling');
                const contextualizationBtn = $('#contextualization');

                const colorBox1 = $('#color-box-1');
                const colorBox2 = $('#color-box-2');

                const contextualizationBox = $('#contextualization-box');

                // Return feature button & function reference to stop the feature
                function getFeatureUtils(feature) {
                  switch (feature) {
                    case "Color":
                      return [colorBtn, stopColor];
                      break;
                    case "Music":
                      return [musicBtn, stopMusic];
                      break;
                    case "Storytelling":
                      return [storytellingBtn, stopStorytelling];
                      break;
                    case "Contextualization":
                      return [contextualizationBtn, stopContextualization];
                      break;
                    default:
                      return null;
                      break;
                  }
                }

                // Initialize color feature
                colorBox1.css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );

                // Start Interactive Color
                function startColor() {
                  colorBox1.css( 'opacity', '1' );
                  colorBox2.css( 'opacity', '1' );
                  light2.attr( 'color', 'rgb(' + lights[0] + ',' + lights[1] + ',' + lights[2] + ')' );

                  color_event = setInterval( color_func, 1500 );
                  light_event = setInterval( light_func, 10 );
                }

                // Stop Interactive Color
                function stopColor() {
                  colorBox1.css( 'opacity', '0' );
                  colorBox2.css( 'opacity', '0' );
                  light1.attr( 'color', '#FFF' );
                  light2.attr( 'color', '#FFF' );
                  clearInterval( color_event );
                  clearInterval( light_event );
                }

                // Color manager
                colorBtn.click(function() {
                  if (!light1 || !light2) return;

                  const status        = arte.getStatus();
                  const activeFeature = arte.getActiveFeature();
                  const feature       = "Color";

                  if( status == 0 ) {
                    colorBtn.addClass('pressed');

                    startColor();

                    arte.startFeature(feature);
                  }
                  else if( status == 1 && activeFeature === feature ) {
                    colorBtn.removeClass('pressed');

                    stopColor();

                    arte.stopFeature();
                    sendMessage();
                  }
                  else if( status == 1 && activeFeature !== feature ) {
                    // Disactive current feature
                    const featureUtils = getFeatureUtils(activeFeature);
                    if (!featureUtils)
                      return;

                    const featureBtn  = featureUtils[0];
                    const featureStop = featureUtils[1];

                    featureBtn.removeClass('pressed');

                    featureStop();

                    arte.stopFeature();
                    sendMessage();

                    // Active Dynamic Artwork
                    colorBtn.addClass('pressed');

                    startColor();

                    arte.startFeature(feature);
                  }
                });


                // List of notes
                const notes = ["C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4", "C5", "C#5"];

                // Start playing music
                function startMusic() {
                  let seed       = 0;
                  let listValues = [];
                  let music      = [];

                  // Generate the seed
                  for (i = 1; i < rooms.length; i++) {
                    seed += rooms[i - 1] * rooms[i]
                  }

                  for (i = 1; i < sensors.length; i++) {
                    for (j = 0; j < sensors[i].length; j++) {
                      seed += sensors[i - 1][j] * sensors[i][j];
                    }

                    listValues.push(Math.floor(seed / i));
                  }

                  const now = Tone.now()

                  // Play random notes
                  for (i = 0; i < listValues.length * 4; i++) {
                    music.push(notes[listValues[i % listValues.length] % 14]);

                    synth.triggerAttackRelease(music[i], "8n", now + i / 2);
                  }

                }

                // Stop playing music
                function stopMusic() {
                  synth.triggerRelease("8n");
                }

                // Music manager
                musicBtn.click(function() {
                  const status        = arte.getStatus();
                  const activeFeature = arte.getActiveFeature();
                  const feature       = "Music";

                  if( status == 0 ) {
                      musicBtn.addClass('pressed');

                      startMusic();

                      arte.startFeature(feature);
                  }
                  else if( status == 1 && activeFeature === feature ) {
                      musicBtn.removeClass('pressed');

                      stopMusic();

                      arte.stopFeature();
                      sendMessage();
                  }
                  else if( status == 1 && activeFeature !== feature ) {
                    // Disactive current feature
                    const featureUtils = getFeatureUtils(activeFeature);
                    if (!featureUtils)
                      return;

                    const featureBtn  = featureUtils[0];
                    const featureStop = featureUtils[1];

                    featureBtn.removeClass('pressed');

                    featureStop();

                    arte.stopFeature();
                    sendMessage();

                    // Active Interactive Music
                    musicBtn.addClass('pressed');

                    startMusic();

                    arte.startFeature(feature);
                  }
                });


                // Start Storytelling
                function startStorytelling(artwork) {
                  // Pick a random audio source relative to the artwork
                  let audioIndex = (Math.floor(Math.random() * 10) * 31) % 3;
                  audioElement.setAttribute('src', './audio/' + artwork + '/' + audioIndex + '.mp3');
                  audioElement.play();
                }

                // Stop Storytelling
                function stopStorytelling() {
                  audioElement.pause();

                  storytellingBtn.removeClass('pressed');

                  audioElement.currentTime = 0;
                }

                // Storytelling manager
                storytellingBtn.click(function() {
                  const status        = arte.getStatus();
                  const activeFeature = arte.getActiveFeature();
                  const feature       = "Storytelling";

                  let artwork = artworkTitle.text();
                  if (!artwork) {
                    alert("Error while activating the storytelling. Try to refresh the page!");
                    return;
                  }

                  if( status == 0 ) {
                    storytellingBtn.addClass('pressed');

                    startStorytelling(artwork);

                    arte.startFeature(feature);
                  }
                  else if( status == 1 && activeFeature === feature ) {
                    storytellingBtn.removeClass('pressed');

                    stopStorytelling();

                    arte.stopFeature();
                    sendMessage();
                  }
                  else if( status == 1 && activeFeature !== feature ) {
                    // Disactive current feature
                    const featureUtils = getFeatureUtils(activeFeature);
                    if (!featureUtils)
                      return;

                    const featureBtn  = featureUtils[0];
                    const featureStop = featureUtils[1];

                    featureBtn.removeClass('pressed');

                    featureStop();

                    arte.stopFeature();
                    sendMessage();

                    // Active Storytelling
                    storytellingBtn.addClass('pressed');

                    startStorytelling(artwork);

                    arte.startFeature(feature);
                  }
                });

                audioElement.addEventListener('ended', function() {
                  stopStorytelling();

                  arte.stopFeature();
                  sendMessage();
                });


                // Start Contextualization
                function startContextualization(artwork) {
                  contextualizationBox.css('background-image', 'url("./img/contextualization/' + artwork + '/image.jpg")');
                  contextualizationBox.css('opacity', '1');
                }

                // Stop Contextualization
                function stopContextualization() {
                  contextualizationBox.css('opacity', '0');
                }

                // Contextualization manager
                contextualizationBtn.click(function() {
                  const status  = arte.getStatus();
                  const activeFeature = arte.getActiveFeature();
                  const feature = "Contextualization";

                  let artwork = artworkTitle.text();
                  if (!artwork) {
                    alert("Error while activating the contextualization. Try to refresh the page!");
                    return;
                  }

                  if( status == 0 ) {
                      contextualizationBtn.addClass('pressed');

                      startContextualization(artwork);

                      arte.startFeature(feature);
                  }
                  else if( status == 1 && activeFeature === feature ) {
                      contextualizationBtn.removeClass('pressed');

                      stopContextualization();

                      arte.stopFeature();
                      sendMessage();
                  }
                  else if( status == 1 && activeFeature !== feature ) {
                    // Disactive current feature
                    const featureUtils = getFeatureUtils(activeFeature);
                    if (!featureUtils)
                      return;

                    const featureBtn  = featureUtils[0];
                    const featureStop = featureUtils[1];

                    featureBtn.removeClass('pressed');

                    featureStop();

                    arte.stopFeature();
                    sendMessage();

                    // Active Contextualization
                    contextualizationBtn.addClass('pressed');

                    startContextualization(artwork);

                    arte.startFeature(feature);
                  }
                });

                // Fix artwork in scene
                /*fixArtwork.click(function() {
                    if( fixArtwork.hasClass('pressed') ) {
                        fixArtwork.removeClass('pressed');
                        sceneEl.attr( 'vr-mode-ui', 'enabled: true' );
                        //artworkModel.object3D.position.set(1, 2, 3);
                    } else {
                        fixArtwork.addClass('pressed');
                        sceneEl.attr( 'vr-mode-ui', 'enabled: false' );
                        //artworkModel.object3D.position.set(1, 2, 3);
                    }

                });*/


                // Set up connection with DynamoDB
                const dynamodb  = new AWS.DynamoDB();
                const docClient = new AWS.DynamoDB.DocumentClient();

                let infoActivated = false;

                infoBtn.click( async function() {
                  if (infoActivated) {
                    infoActivated = false;
                    hideArtworkInfo();
                    infoBtn.removeClass('pressed');
                  }
                  else {
                    const artwork = await queryDB(arte.getArtworkID());
                    if (artwork) {
                      infoActivated = true;
                      showArtworkInfo(artwork);
                      infoBtn.addClass('pressed');
                    }
                  }
                });

                async function queryDB(input) {
                  if (!input)   return null;

                  const params = {
                    TableName : "ARte_Artworks",
                    KeyConditionExpression: "#id = :i",
                    ExpressionAttributeNames: {
                        "#id": "artworkID",
                    },
                    ExpressionAttributeValues: {
                        ":i": input
                    }
                  };

                  return new Promise( function(resolve) {
                    docClient.query(params, onQuery);

                    function onQuery(err, data) {
                      if (err) {
                        alert("Error while loading the information about the artwork. Try to refresh the page!");
                        resolve(null);
                      }
                      else {
                        let artwork;
                        data.Items.forEach(function(a) {
                          artwork = a;
                        });

                        resolve(artwork);
                      }
                    }
                  });
                }

                function showArtworkInfo(artwork) {
                    artworkInfo.html(artwork.description);
                    artworkInfo.toggle();
                }

                function hideArtworkInfo() {
                    artworkInfo.html("");
                    artworkInfo.toggle();
                }


                // This event is triggered when a new marker is recognized
                $('a-nft').on( 'markerFound', function(e) {
                    arte.setArtworkRecognized(true);
                    arte.setArtworkID(this.id);
                    newViewsMap.has(this.id) ? arte.setNewView(false) : arte.setNewView(true);

                    //alert("newView in on marker found: " + arte.newView);
                    //alert("newViewsMap.has(" + this.id + "): " + newViewsMap.has(this.id));

                    // Set artwork title
                    artworkTitle.text(this.title);

                    // Set artwork lights references
                    const children = $(this).children().get();
                    light1 = children[0];
                    light2 = children[1];

                    light1 = $("#" + light1.id);
                    light2 = $("#" + light2.id);

                    // Set variables for the gestures
                    artworkModel = document.getElementById( children[2].children[0].id );

                    initialModelScale    = artworkModel.object3D.scale.clone();
                    let rot = artworkModel.getAttribute("rotation");
                    initialModelRotation = {x: rot.x, y: rot.y, z: rot.z};

                    // Show artwork's title and buttons
                    $('.commands').css('bottom', 0);
                    artworkTitle.toggle();
                    infoBtn.toggle();
                    //fixArtwork.toggle();
                });

                // This event is triggered when a new marker is no more recognized
                $('a-nft').on( 'markerLost', function(e) {
                    if( arte.getStatus() == 1 ) {
                      arte.stopFeature();
                      sendMessage();
                    }

                    arte.setArtworkRecognized(false);
                    arte.setArtworkID(null);

                    reset();
                });


                function reset() {
                  // Reset the Dynamic Artwork
                  stopColor();
                  light1 = null;
                  light2 = null;

                  // Reset the Interactive Music
                  stopMusic();

                  // Reset the Storytelling
                  stopStorytelling();

                  // Reset the Contextualization
                  stopContextualization();

                  // Reset the buttons' status
                  $('.commands').css('bottom', '-22vw');
                  $('.commands .button').removeClass('pressed');

                  artworkTitle.toggle();
                  infoBtn.toggle();
                  //fixArtwork.toggle();

                  if (infoActivated)
                    hideArtworkInfo();

                  // Reset model scale and rotation
                  artworkModel.object3D.scale.x = initialModelScale.x;
                  artworkModel.object3D.scale.y = initialModelScale.y;
                  artworkModel.object3D.scale.z = initialModelScale.z;

                  artworkModel.setAttribute("rotation", initialModelRotation);

                  initialModelScale    = null;
                  initialModelRotation = null;
                  artworkModel = null;
                }


                // Send message to broker when browser is idle mode
                // Set visibilitychange event listener
                function sendMessageIdle() {
                    if ( document.hidden ) {
                        if( arte.getStatus() == 1 ) {
                            arte.stopFeature();
                            sendMessage();
                        }

                    if (arte.getArtworkRecognized())
                        reset();

                        arte.setArtworkRecognized(false);
                        arte.setArtworkID(null);

                        // Clear the map about newViews information
                        newViewsMap.clear();
                    }
                }

                document.addEventListener( 'visibilitychange', sendMessageIdle, false );


                // Light gradient with intensity values
                function light_func() {
                  if (!light1 || !light2) return;

                  var v = light1.attr('light').intensity;
                  if( dir == 1 ) {
                    v -= 0.01;
                  } else {
                    v += 0.01;
                  }

                  if( v == 0 ) {
                    dir = 0;
                  } else if( v == 0.99 ) {
                    dir = 1;
                  }

                  light1.attr('light', 'intensity: ' + v.toFixed(2) );
                  light2.attr('light', 'intensity: ' + (1 - v).toFixed(2) );
                }


                // Change color and rotation degree of baground gradient based on room values
                // Change light colors based on room values
                function color_func() {
                  if (!light1 || !light2) return;

                  for( i = 0; i < 6; i++ ) {
                    colors[i] = 0;
                    for( j = 0; j < Math.floor( rooms.length / 6 ); j++ ) {
                      colors[i] += rooms[i+(j*6)];
                    }
                  }

                  for( i = 0; i < 3; i++ ) {
                    lights[i] = 0;
                    for( j = 0; j < Math.floor( rooms.length / 3 ); j++ ) {
                      lights[i] += Math.round( sensors[i+(j*3)][0] + sensors[i+(j*3)][1] + sensors[i+(j*3)][2] );
                    }
                  }

                  for( i = 0; i < lights.length; i++ ) {
                    lights[i] = Math.max( Math.min( colors[i] + Math.ceil( lights[i] * 50 / ( 60*mult ) ), 255 ), 0 );
                  }

                  for( i = 0; i < colors.length; i++ ) {
                    colors[i] = Math.max( Math.min( ( colors[i] * 255 / ( 20*mult/2 ) ) + ( ( -1+(2*(i%2)) ) * ( lights[i%3] * 30 / ( 60*mult ) ) ), 255 ), 0 );
                  }

                  deg = ( lights.reduce( function( a, b ) { return a + b; }, 0 ) - rooms.reduce( function( a, b ) { return a + b; }, 0 ) ) * 360 / ( 60*mult );

                  SEED = sensors[current_room-1].reduce( function( a, b ) { return a + b; }, 0 );


                  if( time % 2 == 1 ) {
                    light2.attr( 'color', 'rgb(' + lights[0] + ',' + lights[1] + ',' + lights[2] + ')' );
                    colorBox1.css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );
                    colorBox1.css( 'opacity', '1');
                  } else {
                    light1.attr( 'color', 'rgb(' + lights[0] + ',' + lights[1] + ',' + lights[2] + ')' );
                    colorBox2.css( 'background', 'linear-gradient( ' + deg + 'deg, rgba(' + colors[0] + ',' + colors[1] + ',' + colors[2] + ',1) 0%, rgba(' + colors[3] + ',' + colors[4] + ',' + colors[5] + ',1) 100%)' );
                    colorBox1.css( 'opacity', '0');
                  }

                  time = time + 1;

                }
            });

        </script>
    </body>
</html>
